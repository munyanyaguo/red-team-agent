"""
Polymorphic Malware Routes

CRITICAL WARNING: These endpoints generate polymorphic payloads for security testing.
Use ONLY for:
- Authorized red team engagements with explicit written permission
- AV/EDR evasion testing in controlled environments
- Security research and education
- Defensive security training
- Detection algorithm development

Unauthorized use is ILLEGAL and unethical.
"""

from flask import Blueprint, request, jsonify
from flask_jwt_extended import jwt_required, get_jwt_identity
import logging

from .modules.polymorphic_malware import PolymorphicMalware

logger = logging.getLogger(__name__)

polymorphic_malware_bp = Blueprint('polymorphic_malware', __name__)


@polymorphic_malware_bp.route('/polymorphic/generate', methods=['POST'])
@jwt_required()
def generate_polymorphic_payload():
    """
    Generate a single polymorphic payload.

    Request body:
    {
        "base_payload": "<script>alert('XSS')</script>",
        "payload_type": "xss",  // Optional: xss, sql, cmd, generic (default: xss)
        "num_mutations": 2  // Optional: number of mutations to apply (default: 2)
    }

    Returns:
        JSON response with mutated payload and signature info
    """
    try:
        user_id = get_jwt_identity()
        data = request.get_json()

        if not data:
            return jsonify({
                "status": "error",
                "message": "Request body must be JSON"
            }), 400

        base_payload = data.get('base_payload')
        payload_type = data.get('payload_type', 'xss')
        num_mutations = data.get('num_mutations', 2)

        if not base_payload:
            return jsonify({
                "status": "error",
                "message": "Missing required field: base_payload"
            }), 400

        logger.warning(f"⚠️  POLYMORPHIC PAYLOAD GENERATION by user: {user_id}, type: {payload_type}")

        polymorphic = PolymorphicMalware()
        result = polymorphic.polymorphic_payload(base_payload, payload_type, num_mutations)

        if result.get("success"):
            return jsonify({
                "status": "success",
                **result
            }), 200
        else:
            return jsonify({
                "status": "error",
                **result
            }), 400

    except Exception as e:
        logger.error(f"Error generating polymorphic payload: {str(e)}", exc_info=True)
        return jsonify({
            "status": "error",
            "message": f"Internal server error: {str(e)}"
        }), 500


@polymorphic_malware_bp.route('/polymorphic/variants', methods=['POST'])
@jwt_required()
def generate_variants():
    """
    Generate multiple polymorphic variants.

    Request body:
    {
        "base_payload": "<script>alert('XSS')</script>",
        "payload_type": "xss",  // Optional: xss, sql, cmd, generic (default: xss)
        "count": 5  // Optional: number of variants (default: 5)
    }

    Returns:
        JSON response with all unique variants
    """
    try:
        user_id = get_jwt_identity()
        data = request.get_json()

        if not data:
            return jsonify({
                "status": "error",
                "message": "Request body must be JSON"
            }), 400

        base_payload = data.get('base_payload')
        payload_type = data.get('payload_type', 'xss')
        count = data.get('count', 5)

        if not base_payload:
            return jsonify({
                "status": "error",
                "message": "Missing required field: base_payload"
            }), 400

        logger.warning(f"⚠️  POLYMORPHIC VARIANTS GENERATION by user: {user_id}, count: {count}, type: {payload_type}")

        polymorphic = PolymorphicMalware()
        result = polymorphic.generate_variants(base_payload, payload_type, count)

        if result.get("success"):
            return jsonify({
                "status": "success",
                **result
            }), 200
        else:
            return jsonify({
                "status": "error",
                **result
            }), 400

    except Exception as e:
        logger.error(f"Error generating variants: {str(e)}", exc_info=True)
        return jsonify({
            "status": "error",
            "message": f"Internal server error: {str(e)}"
        }), 500


@polymorphic_malware_bp.route('/polymorphic/junk', methods=['POST'])
@jwt_required()
def add_junk_code():
    """
    Add junk code to payload for signature evasion.

    Request body:
    {
        "payload": "<script>alert('XSS')</script>",
        "junk_type": "comment"  // Optional: comment, whitespace, variable (default: comment)
    }

    Returns:
        JSON response with modified payload
    """
    try:
        user_id = get_jwt_identity()
        data = request.get_json()

        if not data:
            return jsonify({
                "status": "error",
                "message": "Request body must be JSON"
            }), 400

        payload = data.get('payload')
        junk_type = data.get('junk_type', 'comment')

        if not payload:
            return jsonify({
                "status": "error",
                "message": "Missing required field: payload"
            }), 400

        logger.info(f"Adding junk code by user: {user_id}, type: {junk_type}")

        polymorphic = PolymorphicMalware()
        result = polymorphic.add_junk_code(payload, junk_type)

        if result.get("success"):
            return jsonify({
                "status": "success",
                **result
            }), 200
        else:
            return jsonify({
                "status": "error",
                **result
            }), 400

    except Exception as e:
        logger.error(f"Error adding junk code: {str(e)}", exc_info=True)
        return jsonify({
            "status": "error",
            "message": f"Internal server error: {str(e)}"
        }), 500


@polymorphic_malware_bp.route('/polymorphic/case', methods=['POST'])
@jwt_required()
def randomize_case():
    """
    Randomize case of payload for signature evasion.

    Request body:
    {
        "payload": "<script>alert('XSS')</script>",
        "strategy": "random"  // Optional: alternate, random, upper, lower (default: alternate)
    }

    Returns:
        JSON response with modified payload
    """
    try:
        user_id = get_jwt_identity()
        data = request.get_json()

        if not data:
            return jsonify({
                "status": "error",
                "message": "Request body must be JSON"
            }), 400

        payload = data.get('payload')
        strategy = data.get('strategy', 'alternate')

        if not payload:
            return jsonify({
                "status": "error",
                "message": "Missing required field: payload"
            }), 400

        logger.info(f"Randomizing case by user: {user_id}, strategy: {strategy}")

        polymorphic = PolymorphicMalware()
        result = polymorphic.randomize_case(payload, strategy)

        if result.get("success"):
            return jsonify({
                "status": "success",
                **result
            }), 200
        else:
            return jsonify({
                "status": "error",
                **result
            }), 400

    except Exception as e:
        logger.error(f"Error randomizing case: {str(e)}", exc_info=True)
        return jsonify({
            "status": "error",
            "message": f"Internal server error: {str(e)}"
        }), 500


@polymorphic_malware_bp.route('/polymorphic/encode', methods=['POST'])
@jwt_required()
def encode_payload():
    """
    Encode payload for evasion.

    Request body:
    {
        "payload": "<script>alert('XSS')</script>",
        "encoding": "hex"  // Optional: hex, unicode, url, base64 (default: hex)
    }

    Returns:
        JSON response with encoded payload
    """
    try:
        user_id = get_jwt_identity()
        data = request.get_json()

        if not data:
            return jsonify({
                "status": "error",
                "message": "Request body must be JSON"
            }), 400

        payload = data.get('payload')
        encoding = data.get('encoding', 'hex')

        if not payload:
            return jsonify({
                "status": "error",
                "message": "Missing required field: payload"
            }), 400

        logger.info(f"Encoding payload by user: {user_id}, encoding: {encoding}")

        polymorphic = PolymorphicMalware()
        result = polymorphic.encode_payload(payload, encoding)

        if result.get("success"):
            return jsonify({
                "status": "success",
                **result
            }), 200
        else:
            return jsonify({
                "status": "error",
                **result
            }), 400

    except Exception as e:
        logger.error(f"Error encoding payload: {str(e)}", exc_info=True)
        return jsonify({
            "status": "error",
            "message": f"Internal server error: {str(e)}"
        }), 500


@polymorphic_malware_bp.route('/polymorphic/advanced', methods=['POST'])
@jwt_required()
def advanced_polymorphism():
    """
    Apply multiple advanced polymorphic techniques.

    Request body:
    {
        "base_payload": "<script>alert('XSS')</script>",
        "payload_type": "xss",  // Optional: xss, sql, cmd, generic (default: xss)
        "techniques": ["mutate", "junk", "case", "encode"]  // Optional: list of techniques
    }

    Returns:
        JSON response with highly mutated payload
    """
    try:
        user_id = get_jwt_identity()
        data = request.get_json()

        if not data:
            return jsonify({
                "status": "error",
                "message": "Request body must be JSON"
            }), 400

        base_payload = data.get('base_payload')
        payload_type = data.get('payload_type', 'xss')
        techniques = data.get('techniques')

        if not base_payload:
            return jsonify({
                "status": "error",
                "message": "Missing required field: base_payload"
            }), 400

        logger.warning(f"⚠️  ADVANCED POLYMORPHISM by user: {user_id}, type: {payload_type}")

        polymorphic = PolymorphicMalware()
        result = polymorphic.advanced_polymorphism(base_payload, payload_type, techniques)

        if result.get("success"):
            return jsonify({
                "status": "success",
                **result
            }), 200
        else:
            return jsonify({
                "status": "error",
                **result
            }), 400

    except Exception as e:
        logger.error(f"Error applying advanced polymorphism: {str(e)}", exc_info=True)
        return jsonify({
            "status": "error",
            "message": f"Internal server error: {str(e)}"
        }), 500


@polymorphic_malware_bp.route('/polymorphic/techniques', methods=['GET'])
@jwt_required()
def get_techniques():
    """
    Get available polymorphic techniques.

    Returns:
        JSON response with available techniques and payload types
    """
    try:
        user_id = get_jwt_identity()
        logger.info(f"Polymorphic techniques requested by user: {user_id}")

        polymorphic = PolymorphicMalware()
        result = polymorphic.get_available_techniques()

        return jsonify({
            "status": "success",
            **result
        }), 200

    except Exception as e:
        logger.error(f"Error getting techniques: {str(e)}", exc_info=True)
        return jsonify({
            "status": "error",
            "message": f"Internal server error: {str(e)}"
        }), 500
