"""
Tests for ExploitationEngine Module
Run with: pytest -k exploitation -v
"""

import pytest
from unittest.mock import patch, MagicMock
from app.modules.exploitation import ExploitationEngine

@pytest.fixture
def exploitation_engine():
    return ExploitationEngine()

class TestExploitationEngine:
    def test_run_exploitation_no_method(self, exploitation_engine):
        finding = {'title': 'Some other vulnerability'}
        result = exploitation_engine.run_exploitation(finding)
        assert result['success'] is False
        assert "No exploitation method available" in result['message']

    @patch.object(ExploitationEngine, '_exploit_sql_injection', return_value={'success': True, 'message': 'SQLi confirmed'})
    def test_run_exploitation_sql_injection(self, mock_exploit_sql_injection, exploitation_engine):
        finding = {'title': 'SQL Injection vulnerability'}
        result = exploitation_engine.run_exploitation(finding)
        assert result['success'] is True
        mock_exploit_sql_injection.assert_called_once_with(finding)

    def test_get_exploit_method_sql_injection(self, exploitation_engine):
        finding = {'title': 'SQL Injection vulnerability'}
        method = exploitation_engine._get_exploit_method(finding)
        assert method == exploitation_engine._exploit_sql_injection

    def test_get_exploit_method_no_match(self, exploitation_engine):
        finding = {'title': 'XSS vulnerability'}
        method = exploitation_engine._get_exploit_method(finding)
        assert method is None

    def test_exploit_sql_injection(self, exploitation_engine):
        finding = {'title': 'SQL Injection vulnerability'}
        result = exploitation_engine._exploit_sql_injection(finding)
        assert result['success'] is True
        assert "SQL Injection vulnerability confirmed." in result['message']
